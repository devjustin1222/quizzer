<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quizzer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --surface: #0f172a;
      --card: #111827;
      --accent: #a855f7;
      --accent-2: #22d3ee;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --correct: #22c55e;
      --incorrect: #ef4444;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(168, 85, 247, 0.2), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(34, 211, 238, 0.25), transparent 30%),
                  radial-gradient(circle at 50% 100%, rgba(34, 211, 238, 0.15), transparent 25%),
                  #0b1120;
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto 48px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .header-spacer { flex: 1; }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.02em;
    }

    .field-label {
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .text-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-size: 14px;
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 14px;
      border-radius: 999px;
      color: var(--muted);
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }

    .panel, .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .panel h2, .card h2 {
      margin-top: 0;
      font-size: 18px;
      letter-spacing: -0.01em;
    }

    .upload-box {
      border: 1px dashed rgba(255, 255, 255, 0.3);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      background: rgba(0,0,0,0.25);
      transition: border-color 150ms ease, transform 150ms ease;
    }

    .upload-box:hover {
      border-color: var(--accent-2);
      transform: translateY(-2px);
    }

    .upload-box input {
      width: 100%;
      cursor: pointer;
    }

    .toggle-group {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
      padding: 6px;
      width: fit-content;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .toggle {
      position: relative;
    }

    .toggle input {
      display: none;
    }

    .toggle label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
      transition: color 120ms ease, background 120ms ease;
    }

    .toggle input:checked + label {
      background: linear-gradient(120deg, rgba(168,85,247,0.6), rgba(34,211,238,0.6));
      color: #0b1120;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.02em;
    }

    .card {
      position: relative;
      overflow: hidden;
    }

    .question-number {
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 6px;
    }

    .question-text {
      font-size: 20px;
      margin: 6px 0 16px;
      letter-spacing: -0.01em;
    }

    .options {
      display: grid;
      gap: 10px;
      margin: 10px 0 20px;
    }

    .option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    .option .bubble {
      height: 28px;
      width: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.2);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--muted);
    }

    .option:hover { transform: translateY(-1px); border-color: rgba(168, 85, 247, 0.6); }

    .option.selected { border-color: var(--accent); background: rgba(168, 85, 247, 0.08); }
    .option.selected .bubble { border-color: var(--accent); color: var(--text); }

    .option.correct { border-color: var(--correct); background: rgba(34,197,94,0.08); }
    .option.incorrect { border-color: var(--incorrect); background: rgba(239,68,68,0.08); }

    .actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }

    button {
      border: none;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: -0.01em;
      border-radius: 12px;
      padding: 12px 16px;
      transition: transform 120ms ease, filter 120ms ease;
    }

    button.primary {
      background: linear-gradient(120deg, #a855f7, #22d3ee);
      color: #0b1120;
      box-shadow: var(--shadow);
    }

    button.secondary {
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button:not(:disabled):active { transform: translateY(1px); filter: brightness(0.95); }

    .status {
      margin-top: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status .pill { padding: 8px 12px; }

    .progress {
      height: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress div {
      height: 100%;
      background: linear-gradient(120deg, #a855f7, #22d3ee);
      width: 0;
      transition: width 200ms ease;
    }

    .summary {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .summary-item {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .summary-item h4 { margin: 0 0 6px; }
    .muted { color: var(--muted); }

    .ai-feedback {
      margin-top: 14px;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
    }

    .ai-feedback h4 {
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      letter-spacing: -0.01em;
    }

    .pill.primary-pill {
      background: linear-gradient(120deg, #a855f7, #22d3ee);
      color: #0b1120;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .ai-body { color: var(--text); line-height: 1.5; }

    .loading-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }

    .loading-dots span {
      height: 8px;
      width: 8px;
      background: linear-gradient(120deg, #a855f7, #22d3ee);
      border-radius: 50%;
      animation: pulse 1s infinite ease-in-out;
    }

    .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.3s; }

    @keyframes pulse {
      0%, 100% { transform: scale(0.85); opacity: 0.6; }
      50% { transform: scale(1.15); opacity: 1; }
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,0.2);
      color: var(--muted);
    }

    .settings-button {
      margin-left: auto;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: grid;
      place-items: center;
      padding: 18px;
      z-index: 10;
    }

    [hidden] { display: none !important; }

    .modal {
      width: min(520px, 100%);
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.45);
      padding: 18px;
      color: var(--text);
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal h3 { margin: 0; letter-spacing: -0.01em; }

    .close-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      border-radius: 10px;
      height: 36px;
      width: 36px;
      display: grid;
      place-items: center;
      font-size: 16px;
    }

    .settings-row { margin: 14px 0; display: grid; gap: 8px; }

    .radio-group { display: grid; gap: 10px; }
    .radio-tile {
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      padding: 12px;
      border-radius: 12px;
      display: grid;
      gap: 6px;
      cursor: pointer;
      transition: border-color 120ms ease, background 120ms ease;
    }

    .radio-tile input { display: none; }

    .radio-tile strong { display: block; }

    .radio-tile input:checked + div {
      border: 1px solid var(--accent);
      background: rgba(168,85,247,0.12);
      box-shadow: var(--shadow);
    }

    .modal-footer { display: flex; justify-content: flex-end; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Quizzer</h1>
      <span class="pill">Upload CSV · Pick a mode · Quiz away</span>
      <div class="header-spacer"></div>
      <button class="secondary settings-button" id="openSettings" type="button">Settings</button>
    </header>

    <div class="layout">
      <section class="panel" aria-label="Quiz controls">
        <h2>Setup</h2>
        <p class="muted">Upload a CSV with columns: <strong>question</strong>, <strong>option1..option4</strong> (or <strong>option_a..option_d</strong>), and <strong>answer/correct</strong> (letter or text). Data stays in your browser.</p>
        <div class="upload-box">
          <input type="file" id="fileInput" accept=".csv" />
          <p class="muted" style="margin:8px 0 0">Drop or choose a CSV to replace questions.</p>
        </div>

        <h3>Quiz mode</h3>
        <div class="toggle-group" role="radiogroup" aria-label="Quiz mode">
          <div class="toggle">
            <input type="radio" name="mode" id="modeInstant" value="instant" checked>
            <label for="modeInstant">Instant feedback</label>
          </div>
          <div class="toggle">
            <input type="radio" name="mode" id="modeFinal" value="final">
            <label for="modeFinal">Final score</label>
          </div>
        </div>

        <div style="margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="primary" id="startBtn">Start quiz</button>
          <button class="secondary" id="sampleBtn" type="button">Use sample quiz</button>
          <span class="badge" id="questionCount">0 questions loaded</span>
        </div>
      </section>

      <section class="card" aria-live="polite">
        <div id="quizArea"></div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="settingsModal" hidden aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" tabindex="-1">
      <div class="modal-header">
        <h3 id="settingsTitle">Settings</h3>
        <button class="close-btn" id="closeSettings" aria-label="Close settings">×</button>
      </div>
      <div class="settings-row">
        <label class="field-label" for="apiKey">OpenAI API key (optional)</label>
        <input type="password" class="text-input" id="apiKey" placeholder="sk-..." autocomplete="off" />
        <div class="hint">Stored only in this browser and used to generate AI explanations when answers are incorrect.</div>
      </div>
      <div class="settings-row">
        <div class="field-label">AI response style</div>
        <div class="radio-group" id="aiStyles"></div>
        <div class="hint">Choose how the AI explains mistakes after incorrect answers.</div>
      </div>
      <div class="modal-footer">
        <button class="secondary" type="button" id="closeSettingsFooter">Close</button>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const quizArea = document.getElementById('quizArea');
    const questionCount = document.getElementById('questionCount');
    const startBtn = document.getElementById('startBtn');
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const apiKeyInput = document.getElementById('apiKey');
    const openSettingsBtn = document.getElementById('openSettings');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettings');
    const closeSettingsFooter = document.getElementById('closeSettingsFooter');
    const aiStylesContainer = document.getElementById('aiStyles');

    let questions = [];
    let responses = [];
    let currentIndex = 0;
    let statusState = { message: '', type: 'info' };
    let aiExplanations = [];
    let openAIKey = localStorage.getItem('quizzer-openai-key') || '';
    let aiResponseStyle = localStorage.getItem('quizzer-ai-response-style') || 'concise-bullets';

    const aiResponseOptions = {
      'concise-bullets': {
        title: 'Crisp bullet tutor',
        description: 'Clear, direct, 3-5 bullet points focused on the misconception and the right idea.',
        system: 'You are a concise tutor who explains quiz mistakes in 3-5 punchy bullet points focused on why the chosen answer is wrong and why the correct answer is right. Keep bullets short and actionable.',
        userInstruction: 'Use bullet points. Lead with the main misconception, then clarify the correct idea.'
      },
      'encouraging-coach': {
        title: 'Encouraging coach',
        description: 'Conversational, upbeat, and supportive while teaching the right reasoning.',
        system: 'You are an encouraging, conversational teacher who mixes warmth with guidance. Use a friendly tone, acknowledge effort, and give clear teaching moments.',
        userInstruction: 'Reply in 2-3 short paragraphs. Start with a quick encouragement, then kindly correct the mistake and give a memorable tip.'
      },
      'tough-love-instructor': {
        title: 'Tough-love instructor',
        description: 'Blunt but informative. Directly call out the mistake and teach the fix.',
        system: 'You are a firm instructor with tough-love energy. You call out mistakes directly but always provide precise teaching so the learner improves.',
        userInstruction: 'Answer in 4-6 sentences. Be frank about what was wrong, then clearly walk through the correct reasoning.'
      }
    };

    apiKeyInput.value = openAIKey;

    apiKeyInput.addEventListener('input', (event) => {
      openAIKey = event.target.value.trim();
      if (openAIKey) {
        localStorage.setItem('quizzer-openai-key', openAIKey);
      } else {
        localStorage.removeItem('quizzer-openai-key');
      }
    });

    function renderAiStyles() {
      aiStylesContainer.innerHTML = Object.entries(aiResponseOptions).map(([value, option]) => {
        const checked = value === aiResponseStyle ? 'checked' : '';
        return `
          <label class="radio-tile">
            <input type="radio" name="aiStyle" value="${value}" ${checked} />
            <div>
              <strong>${option.title}</strong>
              <span class="muted">${option.description}</span>
            </div>
          </label>
        `;
      }).join('');

      aiStylesContainer.querySelectorAll('input[name="aiStyle"]').forEach(input => {
        input.addEventListener('change', (event) => {
          aiResponseStyle = event.target.value;
          localStorage.setItem('quizzer-ai-response-style', aiResponseStyle);
        });
      });
    }

    function openSettings() {
      settingsModal.hidden = false;
      settingsModal.setAttribute('aria-hidden', 'false');
      const modal = settingsModal.querySelector('.modal');
      if (modal) modal.focus();
      if (apiKeyInput) {
        requestAnimationFrame(() => apiKeyInput.focus());
      }
    }

    function closeSettings() {
      settingsModal.hidden = true;
      settingsModal.setAttribute('aria-hidden', 'true');
    }

    openSettingsBtn.addEventListener('click', () => {
      renderAiStyles();
      openSettings();
    });

    renderAiStyles();

    closeSettingsBtn.addEventListener('click', closeSettings);
    closeSettingsFooter.addEventListener('click', closeSettings);
    settingsModal.addEventListener('click', (event) => {
      if (event.target === settingsModal) closeSettings();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && settingsModal.getAttribute('aria-hidden') === 'false') {
        closeSettings();
      }
    });

    const sampleCSV = `question,option_a,option_b,option_c,option_d,correct\nWhat does HTML stand for?,Hyper Trainer Marking Language,Hyper Text Markup Language,Hyper Text Marketing Language,Hyper Text Markup Leveler,B\nWhich method converts JSON to JavaScript object?,JSON.parse(),JSON.stringify(),JSON.toJS(),JSON.convert(),A\nHow many bits make up an IPv6 address?,32 bits,64 bits,128 bits,256 bits,C\nWhich CSS property changes text color?,font-style,text-decoration,color,text-shadow,C`;

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length === 0) return [];
      const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h => h.trim().toLowerCase());
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i];
        if (!row.trim()) continue;
        const cols = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
        const record = {};
        headers.forEach((h, idx) => record[h] = cols[idx] ?? '');
        const optionKeys = Object.keys(record).filter(k => k.startsWith('option'));
        const options = optionKeys.map(k => record[k]).filter(Boolean);
        const answerRaw = record['answer'] || record['correct'] || record['correct_answer'] || '';
        const answerIndex = parseAnswer(answerRaw, options);
        if (!record.question || options.length === 0 || answerIndex === -1) continue;
        data.push({ question: record.question, options, answerIndex });
      }
      return data;
    }

    function parseAnswer(value, options) {
      if (!value) return -1;
      const letter = value.trim().toUpperCase();
      const letterIndex = letter.charCodeAt(0) - 65;
      if (letterIndex >= 0 && letterIndex < options.length && /^[A-Z]$/.test(letter)) return letterIndex;
      const byText = options.findIndex(opt => opt.toLowerCase() === value.trim().toLowerCase());
      return byText;
    }

    function setQuestions(newQuestions) {
      questions = newQuestions;
      questionCount.textContent = `${questions.length} question${questions.length === 1 ? '' : 's'} loaded`;
      resetQuiz();
      renderEmptyState();
    }

    function resetQuiz() {
      responses = questions.map(() => ({ selected: null, checked: false }));
      aiExplanations = questions.map(() => ({ status: 'idle', message: '' }));
      currentIndex = 0;
      statusState = { message: '', type: 'info' };
    }

    function getMode() {
      return document.querySelector('input[name="mode"]:checked').value;
    }

    function renderEmptyState(message = 'Upload a CSV to begin or use the sample set.') {
      quizArea.innerHTML = `<div class="empty-state">${message}</div>`;
    }

    function renderQuestion() {
      if (!questions.length) {
        renderEmptyState();
        return;
      }
      const q = questions[currentIndex];
      const response = responses[currentIndex];
      const mode = getMode();
      const progress = ((currentIndex) / questions.length) * 100;
      const aiSection = renderAiFeedback(currentIndex);

      quizArea.innerHTML = `
        <div class="progress" aria-hidden="true"><div style="width:${progress}%"></div></div>
        <div class="question-number">Question ${currentIndex + 1} of ${questions.length}</div>
        <div class="question-text">${q.question}</div>
        <div class="options" role="list">
          ${q.options.map((opt, idx) => {
            const letters = String.fromCharCode(65 + idx);
            let classes = 'option';
            if (response.selected === idx) classes += ' selected';
            if (mode === 'instant' && response.checked) {
              if (idx === q.answerIndex) classes += ' correct';
              else if (response.selected === idx && idx !== q.answerIndex) classes += ' incorrect';
            }
            return `<button type="button" class="${classes}" data-index="${idx}" role="listitem">
              <span class="bubble">${letters}</span>
              <span>${opt}</span>
            </button>`;
          }).join('')}
        </div>
        <div class="actions">
          <button class="secondary" id="prevBtn" ${currentIndex === 0 ? 'disabled' : ''}>Back</button>
          <button class="primary" id="nextBtn">${currentIndex === questions.length - 1 ? 'Finish' : 'Next'}</button>
          ${mode === 'instant' ? '<button class="secondary" id="checkBtn">Check answer</button>' : ''}
        </div>
        <div class="status" id="statusArea"></div>
        ${aiSection}
      `;

      quizArea.querySelectorAll('.option').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.index);
          responses[currentIndex].selected = idx;
          if (mode === 'instant') {
            responses[currentIndex].checked = false;
            aiExplanations[currentIndex] = { status: 'idle', message: '' };
          }
          setStatus('');
          renderQuestion();
        });
      });

      document.getElementById('prevBtn').onclick = () => moveTo(currentIndex - 1);
      document.getElementById('nextBtn').onclick = () => {
        if (mode === 'instant') {
          if (!response.checked) {
            setStatus('Please check your answer first.', 'warning');
            return;
          }
        } else {
          if (response.selected === null) {
            setStatus('Select an option to continue.', 'warning');
            return;
          }
        }
        if (currentIndex === questions.length - 1) {
          showResults();
        } else {
          moveTo(currentIndex + 1);
        }
      };

      if (mode === 'instant') {
        const checkBtn = document.getElementById('checkBtn');
        checkBtn.onclick = () => {
          if (response.selected === null) {
            setStatus('Choose an option to check.', 'warning');
            return;
          }
          responses[currentIndex].checked = true;
          const correct = response.selected === q.answerIndex;
          setStatus(correct ? 'Correct! Nice work.' : `Not quite. The correct answer is ${String.fromCharCode(65 + q.answerIndex)}.`, correct ? 'success' : 'error');
          if (!correct) {
            fetchAiExplanation(currentIndex);
          } else {
            aiExplanations[currentIndex] = { status: 'idle', message: '' };
          }
          renderQuestion();
        };
      }
      setStatus(statusState.message, statusState.type);
    }

    function renderAiFeedback(index) {
      const mode = getMode();
      const response = responses[index];
      if (mode !== 'instant' || !response?.checked) return '';

      const q = questions[index];
      if (!q || response.selected === q.answerIndex) return '';

      const entry = aiExplanations[index] || { status: 'idle', message: '' };
      if (!openAIKey && entry.status === 'idle') {
        return `<div class="ai-feedback"><h4>Why was this incorrect?</h4><div class="hint">Add your OpenAI API key to generate a personalized explanation.</div></div>`;
      }

      if (entry.status === 'loading') {
        return `<div class="ai-feedback"><h4>Generating explanation</h4><div class="loading-dots" aria-live="polite"><span></span><span></span><span></span></div></div>`;
      }

      if (entry.status === 'error') {
        return `<div class="ai-feedback"><h4>Explanation unavailable</h4><div class="hint">${entry.message}</div></div>`;
      }

      if (entry.status === 'ready') {
        return `<div class="ai-feedback"><h4><span class="pill primary-pill">AI feedback</span> Explanation</h4><div class="ai-body">${entry.message}</div></div>`;
      }

      return '';
    }

    async function fetchAiExplanation(index) {
      const entry = aiExplanations[index];
      const response = responses[index];
      if (!response || response.selected === null) return;
      if (entry && (entry.status === 'loading' || entry.status === 'ready')) return;

      if (!openAIKey) {
        aiExplanations[index] = { status: 'idle', message: '' };
        renderQuestion();
        return;
      }

      aiExplanations[index] = { status: 'loading', message: '' };
      renderQuestion();

      const q = questions[index];
      const userAnswer = q.options[response.selected];
      const correctAnswer = q.options[q.answerIndex];

      const style = aiResponseOptions[aiResponseStyle] || aiResponseOptions['concise-bullets'];

      const messages = [
        { role: 'system', content: style.system },
        { role: 'user', content: `Question: ${q.question}\nIncorrect answer: ${userAnswer}\nCorrect answer: ${correctAnswer}\nExplain why the chosen answer is wrong and why the correct answer is right. ${style.userInstruction}` }
      ];

      try {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openAIKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages,
            temperature: 0.5,
            max_tokens: 250
          })
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`OpenAI request failed (${res.status}). ${errorText}`);
        }

        const data = await res.json();
        const content = data?.choices?.[0]?.message?.content?.trim() || 'No explanation returned.';
        const safeContent = content
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\n/g, '<br>');
        aiExplanations[index] = { status: 'ready', message: safeContent };
      } catch (error) {
        aiExplanations[index] = { status: 'error', message: error.message || 'Unable to fetch explanation.' };
      }

      renderQuestion();
    }

    function setStatus(message, type = 'info') {
      statusState = { message, type };
      const statusArea = document.getElementById('statusArea');
      if (!statusArea) return;
      if (!message) { statusArea.innerHTML = ''; return; }
      const colors = {
        success: 'var(--correct)',
        error: 'var(--incorrect)',
        warning: '#f59e0b',
        info: 'var(--muted)'
      };
      statusArea.innerHTML = `<span class="pill" style="color:${colors[type] || 'var(--muted)'}">${message}</span>`;
    }

    function moveTo(index) {
      if (index < 0 || index >= questions.length) return;
      currentIndex = index;
      setStatus('');
      renderQuestion();
    }

    function calculateScore() {
      let correct = 0;
      responses.forEach((resp, idx) => {
        if (resp.selected === questions[idx].answerIndex) correct++;
      });
      return { correct, total: questions.length };
    }

    function showResults() {
      const { correct, total } = calculateScore();
      const mode = getMode();
      const summaryItems = questions.map((q, idx) => {
        const resp = responses[idx];
        const isCorrect = resp.selected === q.answerIndex;
        const selection = resp.selected != null ? q.options[resp.selected] : 'Not answered';
        return `<div class="summary-item">
          <h4>Q${idx + 1}: ${q.question}</h4>
          <div class="muted">Your pick: ${selection}</div>
          <div style="color:${isCorrect ? 'var(--correct)' : 'var(--incorrect)'}; font-weight:700;">${isCorrect ? 'Correct' : 'Correct answer: ' + q.options[q.answerIndex]}</div>
        </div>`;
      }).join('');

      quizArea.innerHTML = `
        <div class="question-text">${mode === 'instant' ? 'Quiz complete!' : 'Results ready.'}</div>
        <div class="pill" style="color:var(--text); background: rgba(255,255,255,0.06);">Score: ${correct}/${total} (${Math.round((correct/total)*100)}%)</div>
        <div class="summary">${summaryItems}</div>
        <div class="actions" style="margin-top:16px;">
          <button class="primary" id="restartBtn">Restart</button>
        </div>
      `;

      document.getElementById('restartBtn').onclick = () => {
        resetQuiz();
        renderQuestion();
      };
    }

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      file.text().then(text => {
        const parsed = parseCSV(text);
        if (!parsed.length) {
          renderEmptyState('Could not find valid questions in this file.');
          questionCount.textContent = '0 questions loaded';
          return;
        }
        setQuestions(parsed);
        setStatus('Questions loaded! Press start when you are ready.', 'success');
        renderQuestion();
      });
    });

    startBtn.addEventListener('click', () => {
      if (!questions.length) {
        setStatus('Add a CSV or load the sample quiz first.', 'warning');
        renderEmptyState('Upload a CSV to begin.');
        return;
      }
      resetQuiz();
      setStatus('');
      renderQuestion();
    });

    document.getElementById('sampleBtn').addEventListener('click', () => {
      setQuestions(parseCSV(sampleCSV));
      setStatus('Sample quiz loaded. Press start when you are ready.', 'info');
      renderQuestion();
    });

    modeRadios.forEach(r => r.addEventListener('change', () => {
      resetQuiz();
      setStatus('');
      renderQuestion();
    }));

    renderEmptyState('Upload a CSV to begin or use the sample quiz.');
  </script>
</body>
</html>
